<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLOWS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="styles.css">
    
    
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.10.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.10.0/mapbox-gl.js"></script>
    
    
</head>
<body>
    <!--plugins-->
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.css" type="text/css">
    
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg sticky-top bg-white"  style="position: fixed; width: 100vw;">
        <div class="container-fluid py-2 d-flex justify-content-evenly">
            <a class="navbar-brand" href="index.html">
            <img src="./assets/logo.png" alt="Flows Logo" width="60" height="54">
            </a>
            <div class="navbar-nav">
                <a class="nav-link fs-5 fw-semibold mx-2 text-black" href="map.html">Flood Extent Map</a>
                <a class="nav-link fs-5 fw-semibold mx-2 text-black" href="about.html">About</a>
            </div>
            <a class="btn btn-darkBlue rounded-pill fw-semibold px-4 fs-5" href="#">Read the Paper</a>
        </div>
    </nav>

       
    <!--Map-->    
    <section id="map">
        <div id="map"></div>
        <div class="overlay">
            <div class="sub-overlay">
                <div class="card bg-lightBlue border-0 rounded-5 p-2">
                    <div class="card-body">
                        <h5 class="fw-bold text-white ">Showing prediction for</h5>
                        <!-- <p class="card-subtitle text-white lh-sm fs-6">Add locations within Camaligan to see the predicted flood level for this specific date and time. Press '×' to remove the location.</p> -->
                        <div class="card mt-1 text-dark rounded-5 p-2">
                        </div>
                    </div>
                </div>
            </div>
            <div class="sub-overlay mt-2" style="z-index: 13;">	
                <div class="card bg-lightBlue border-0 rounded-5 p-2">
                    <div class="card-body">
                        <h5 class="fw-bold text-white ">Monitored Locations</h5>
                        <p class="card-subtitle text-white lh-sm fs-6 mb-2">Add locations within Camaligan to see the predicted flood level for this specific date and time. Press '×' to remove the location.</p>
                        <div id="search-container"></div>
                        <div id="location-list"></div>	
                    </div>
                </div>
            </div>
            <div class="sub-overlay mt-2" style="z-index: 10;">
                <div class="card bg-lightBlue border-0 rounded-5 p-2">
                    <div class="card-body">
                        <h5 class="fw-bold text-white ">Nearby Critical Facilities</h5>
                        <p class="card-subtitle text-white lh-sm fs-6 mb-2">These are important locations such as evacuation centers, schools, and medical centers near your current selected pinpoint.</p>
                        <div id="facility-list-container">
                            <div id="facility-list">

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </section>
            

 
    
    
    <!-- Scripts -->
    <script>
    // TO MAKE THE MAP APPEAR YOU MUST
	// ADD YOUR ACCESS TOsKEN FROM
	// https://account.mapbox.com
    
    const ACCESS_TOKEN = 'pk.eyJ1IjoiZ2F2aW5jaWkiLCJhIjoiY204YjBqNGVhMWEwYzJuczc5dmcyOWM0biJ9.Fsdka6-GWmAFXeLPsg9_dg';
	mapboxgl.accessToken = ACCESS_TOKEN;
    navigator.geolocation.getCurrentPosition(successLocation, errorLocation, { enableHighAccuracy: true });
    const datasetId = 'cm89a2b3m4ab51mpd8gm1v4u9'; // Replace with your actual dataset ID
    const accessToken = ACCESS_TOKEN; // Replace with your access token
    

    function successLocation(position) {
        console.log(position);
        setupMap([position.coords.longitude, position.coords.latitude]);
    }

    function errorLocation() {
        setupMap([123.160705, 13.623460]);
    }

    function setupMap(center) {
        const map = new mapboxgl.Map({
            container: 'map', // container ID
            style: 'mapbox://styles/gavincii/cm7e1z9x6007j01ri5nboff2l/draft', // style URL
            //style: 'mapbox://styles/mapbox/satellite-streets-v12',
            center: [123.160705, 13.623460], // starting position [lng, lat]. Note that lat must be set between -90 and 90
            zoom: 15.5, // starting zoom
            pitch: 45
        });
      
        map.addControl(new mapboxgl.NavigationControl(), 'top-right');
        map.addControl(new mapboxgl.GeolocateControl({
            positionOptions: { enableHighAccuracy: true },
            trackUserLocation: true
        }), 'top-right');

        fetch('dataset.geojson') // Load the downloaded GeoJSON file
        .then(response => response.json())
        .then(geojsonData => {
            console.log("Loaded GeoJSON Data:", geojsonData);

                        // Check if data is in expected format
            if (!geojsonData.features) {
                console.error("GeoJSON format is incorrect. No 'features' property found.");
                return;
            }

            // Example: Log the first feature to verify structure
            if (geojsonData.features.length > 0) {
                console.log("First Feature:", geojsonData.features[0]);
            }

            // Define localGeocoder function for searching within the dataset
            function localGeocoder(query) {
                console.log("Geocoder Search Query:", query); // Debug search query

                const results = geojsonData.features
                    .filter(feature => 
                        feature.properties && 
                        feature.properties.name &&
                        feature.properties.name.toLowerCase().includes(query.toLowerCase())
                    )
                    .map(feature => ({
                        text: feature.properties.name, // Display name in search results
                        place_name: feature.properties.name,
                        center: feature.geometry.coordinates, // Coordinates for result
                        geometry: feature.geometry,
                    }));

                console.log("Filtered Results:", results); // Debug filtered results
                return results;
            }

            // Initialize MapboxGeocoder with local dataset search
            const geocoder = new MapboxGeocoder({
                accessToken: mapboxgl.accessToken,
                localGeocoder: localGeocoder,
                zoom: 15,
                mapboxgl: mapboxgl,
                placeholder: 'Search for a location',
                container: document.getElementById('search-container')
            });

            document.getElementById('search-container').appendChild(geocoder.onAdd(map));

            geocoder.on('result', async (event) => {
            // When the geocoder returns a result
            const point = event.result.center; // Capture the result coordinates
            console.log(point);
            const tileset = 'gavincii.cm8bbl9jm8w9n1nnbrh5vzu9t-4sfg3'; // replace this with the ID of the tileset you created
            const radius = 1609; // 1609 meters is roughly equal to one mile
            const limit = 10; // The maximum amount of results to return

           // marker.setLngLat(point).addTo(map); // Add the marker to the map at the result coordinates
            const query = await fetch(
                `https://api.mapbox.com/v4/${tileset}/tilequery/${point[0]},${point[1]}.json?radius=${radius}&limit=${limit}&access_token=${mapboxgl.accessToken}`,
                { method: 'GET' }
            );
            const json = await query.json();
                console.log(json);
                //const features = json.features;
                updateOverlay(json.features, map);
            });
                
        })
        .catch(error => console.error("Error loading GeoJSON:", error));

    }

 
    function updateOverlay(features, map) {
        const facilityList = document.getElementById("facility-list");
        facilityList.innerHTML = ""; // Clear previous entries

        features.forEach(feature => {
            let coordinates = feature.geometry.coordinates; // Extract coordinates
            let name = feature.properties.name || "Unknown Facility";
            let distance = (feature.properties.tilequery.distance / 1000).toFixed(2); // Convert meters to km
            let amenity = feature.properties.amenity || "default"; // Get the amenity type
            
            const iconMap = {
                "police_station": "assets/icons/GovernmentService.svg",
                "fire_station": "assets/icons/GovernmentService.svg",
                "school": "assets/icons/School.svg",
                "hospital": "assets/icons/Hospital.svg",
                "evacuation_centerr": "assets/icons/Evacuation.svg",
                "miscellaneous": "assets/icons/Misc.svg",
                "government": "assets/icons/Government.svg"
            };
            iconPath = iconMap[amenity] || "assets/icons/Misc.svg";

            const el = document.createElement('div');
             el.className = 'marker';
             el.style.backgroundImage = iconPath;
             el.style.width = `50px`;
             el.style.height = `50px`;
             el.style.backgroundSize = '100%';

            let marker = new mapboxgl.Marker(el)
                 .setLngLat(coordinates)
                 .addTo(map);
                
            // Show popup on hover
            marker.getElement().addEventListener('mouseenter', () => {
                popup.setLngLat(coordinates).addTo(map);
            });

            // Hide popup when mouse leaves
            marker.getElement().addEventListener('mouseleave', () => {
                popup.remove();
            });

             // Create Bootstrap Card
            let card = document.createElement("div");
            card.className = "card mb-2 rounded-4"; // Add Bootstrap card classes
            card.innerHTML = `
                <div class="card-body d-flex align-items-center p-3">
                    <div class="me-3">
                        <img src="${iconPath}" alt="${amenity}" width="30" height="30">
                    </div>
                    <div>
                        <h6 class="fw-bold text-darkBlue">${name}</h6>
                        <p class="card-subtitle text-lightBlue fw-medium fs-6 fst-italic lh-sm">${distance} km away</p>
                    </div>
                </div>
            `;

            // Append the card to the facility list
            facilityList.appendChild(card);
        });
    }

    

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>